<!DOCTYPE html>
<meta charset="utf-8">
<!-- Bootstrap
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous"> -->
<!-- Custom -->
<link rel="stylesheet" type="text/css" href="css/stitch.css"/>

<body>
    <div id="vis-box">
        <svg id="vis" xmlns="http://www.w3.org/2000/svg" width="500" height="500" viewBox="0 0 125 125">
        </svg>
    </div>
    
    <div id="controls">
        <div class="form-group">
            <fieldset>
                <legend>Grid:</legend>
                <label for="grid-size-x">
                    <input type="number" id="grid-size-x" name="grid-size">
                </label> by
                <label for="grid-size-y">
                    <input type="number" id="grid-size-y" name="grid-size">
                </label>
            </fieldset>
        </div>
        <div class="form-group">
            <fieldset>
                <legend>Color:</legend>
                <label for="primary-color">Primary
                    <input type="color" id="primary-color" />
                </label>
                <label for="constrast-color">Contrast
                    <input type="color" id="contrast-color" />
                </label>
            </fieldset>
        </div>
        <div class="form-group">
            <fieldset>
                <legend>Preview:</legend>
                <button id="preview-generator" type="button">Generate Preview</button>
            </fieldset>
        </div>
    </div>

    <div id="preview">
        <svg xmlns="http://www.w3.org/2000/svg" id="vis-preview"></svg>
    </div>
    <!-- Bootstrap + Dependencies, incl jQuery 
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
    -->

    <!-- App -->
    <script type="text/javascript">
    var defaultPrimaryColor = "#ffffff";
    var defaultContrastColor = "#000000";

    //Initial setup
    var mouseDown = false;
    document.addEventListener("mousedown", function() {
        if (!mouseDown)
            mouseDown = true;
    })

    document.addEventListener("mouseup", function() {
        if (mouseDown)
            mouseDown = false;
    })

    var inputPrimaryColor = document.getElementById('primary-color');
    var inputContrastColor = document.getElementById('contrast-color');
    
    inputPrimaryColor.value = defaultPrimaryColor;
    inputContrastColor.value = defaultContrastColor;

    inputPrimaryColor.addEventListener('change', function() { changeColorSet('primary-color') })
    inputContrastColor.addEventListener('change', function() { changeColorSet('contrast-color') })

    document.getElementById('preview-generator').addEventListener('click', function(e) {
        e.preventDefault();
        generatePreview();
        return false;
    })

    var axes = document.createElementNS("http://www.w3.org/2000/svg", "g");

    // Make grid vis
    for (var i = 0; i < 10; i++) {
        
        for (var j = 0; j < 10; j++) {
            var rect = document.createElementNS("http://www.w3.org/2000/svg", "rect")
            
            //calc placement
            var xBuffer = 0;
            var yBuffer = 0;
            var xLoc = i * 10 + xBuffer;
            var yLoc = j * 10 + yBuffer;
            var axisHeight = 10;
            var axisWidth = 10;

            //rectangles
            rect.setAttribute("width", 10);
            rect.setAttribute("height", 10);
            rect.setAttribute('class', 'primary-color')
            rect.setAttribute('fill', defaultPrimaryColor);
            rect.addEventListener("mousedown", function(e) {
                changeColor(e)
            });
            rect.addEventListener("mouseover", dragChangeColor);
            rect.setAttribute('x', xLoc + axisWidth);
            rect.setAttribute('y', yLoc + axisHeight);
            document.getElementById('vis').appendChild(rect);

            //y-axis
            if (i == 0) {
                var label = document.createElementNS("http://www.w3.org/2000/svg", "text")
                label.innerHTML = 10- j;
                label.setAttribute('class', 'label');
                label.setAttribute('x', xLoc);
                label.setAttribute('y', yLoc + axisHeight*2);
                axes.appendChild(label);
            }
            //x-axis
            if (j % 10 == 0) {
                var label = document.createElementNS("http://www.w3.org/2000/svg", "text")
                label.innerHTML = 10-i;
                label.setAttribute('class', 'label');
                label.setAttribute('x', xLoc + axisWidth + (axisWidth/4));
                label.setAttribute('y', yLoc + axisHeight);
                axes.appendChild(label);
            }
            
        }
    }

    document.getElementById('vis').appendChild(axes); //add last to make them bottom in z-index

    /* Functions */
    function changeColor(e) {
        var block = e.target;
        var newClass = block.getAttribute('class') == 'primary-color' ? 'contrast-color' : 'primary-color';
        var newColor = block.getAttribute('class') == 'primary-color' ? inputContrastColor.value : inputPrimaryColor.value;
        block.setAttribute('class', newClass);
        e.target.setAttribute("fill", newColor);
    }

    function dragChangeColor(e) {
        if (mouseDown) {
            changeColor(e);
        }
    }

    function changeColorSet(which) {
        var blocks =  document.querySelectorAll('.'+ which);
        if (which.indexOf('primary') > -1)
            newColor = inputPrimaryColor.value;
        if (which.indexOf('contrast') > -1)
            newColor = inputContrastColor.value;
        blocks.forEach(function(elem) {
            elem.setAttribute('fill', newColor);
        })
    }

    function generatePreview() {
        //remove any old preview first
        var oldPattern = document.querySelectorAll('#vis-preview g.pattern');
        console.log(oldPattern);
        oldPattern.forEach(function(elem) {
            document.getElementById('vis-preview').removeChild(elem);
        })

        var pattern = document.querySelectorAll('#vis rect');
        var repeats = 10;
        document.getElementById('vis-preview').setAttribute('width', repeats * 100 + 20)
        for (var i = 0; i < repeats; i++) {
            var grouper = document.createElementNS("http://www.w3.org/2000/svg", "g");
            grouper.setAttribute('class', 'pattern')
            grouper.setAttribute("transform", "translate(" + i * 100 + ")");
            pattern.forEach(function(elem) {
                var cloneNode = elem.cloneNode();
                grouper.appendChild(cloneNode);
            })
            document.getElementById('vis-preview').appendChild(grouper);
        }
    }

    </script>
</body>